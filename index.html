<html>
<head>
<style>
canvas {
	border: 1px solid black;
}
</style>
<script src="core.js"></script>
<script src="mmu.js"></script>
<script src="io.js"></script>
<script src="video.js"></script>
<script src="irq.js"></script>
<script src="xhr.js"></script>
<script>
function simulate() {
	var start = new Date().getTime();
	// The GBA runs at 16.78MHz, so let's see how long it takes to simulate a GBA-second.
	try {
		for (var i = 0; i < 16780000; ++i) {
			core.step();
		}

		var elapsed = (new Date().getTime() - start) / 1000.0;
		document.getElementById('elapsed').innerText = elapsed;

		//setTimeout(simulate, (elapsed < 1000) ? (1000 - elapsed) : 0);
	} catch (e) {
		var elapsed = (new Date().getTime() - start) / 1000.0;
		document.write(e + " at 0x" + core.nextPC.toString(16) + " after " + elapsed + " seconds");
	}
}

function runTest(r) {
	mmu.loadRom(r);

	simulate();
}
var core = new ARMCore();
var mmu = new GameBoyAdvanceMMU();
var irq = new GameBoyAdvanceInterruptHandler();
var io = new GameBoyAdvanceIO();
var video = new GameBoyAdvanceVideo();
mmu.setIO(io);
io.setVideo(video);
irq.addIrqProvider(video);
core.resetCPU(0x08000000, mmu, irq, io);
window.onload = function() {
	var canvas = document.getElementById('screen');
	video.setCanvas(canvas);
	loadRom('test.rom', runTest);
};
</script>
</head>
<body>
<canvas id="screen" width="240" height="160"></canvas>
<p>1 GBA-second emulated in <span id="elapsed">undefined</span> seconds.</p>
<button onclick="simulate()">Once more</button>
</body>
</html>
